{% load static %}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEICå­¸ç¿’å¹³å° - æ‡‰ç­”å•é¡Œ</title>
    <link rel="stylesheet" href="{% static 'css/common.css' %}">
    <link rel="stylesheet" href="{% static 'css/part2.css' %}">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="header">
        <button class="menu-btn" id="menu-btn">â˜°</button>
        <h1>TOEICå­¸ç¿’å¹³å°</h1>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span class="reading-title">æ‡‰ç­”å•é¡Œ</span>
    </div>

    <div class="container">
        <h1>Response to Questions</h1>
        
        {# éŸ³é »æ’­æ”¾èˆ‡æ§åˆ¶å€åŸŸ #}
        <div class="audio-player-box">
            <p>è«‹è†è½å•é¡Œï¼Œç„¶å¾Œå¾é¸é …ä¸­é¸å‡ºæœ€åˆé©çš„å›æ‡‰ã€‚</p>
            <div class="audio-controls">
                <button class="play-audio-btn" onclick="playQuestionAudio()">æ’­æ”¾å•é¡Œ</button>
                <button class="stop-audio-btn" onclick="stopSpeech()">åœæ­¢æ’­æ”¾</button>
            </div>
            <p class="instruction">å•é¡Œåªæœƒæ’­æ”¾ä¸€æ¬¡ï¼Œè«‹ä»”ç´°è†è½ã€‚</p>
        </div>
        
        {# æ¸¬é©—é¡Œç›®èˆ‡é¸é …å€åŸŸ #}
        <div class="quiz-box">
            <p id="question-number"></p> {# é¡¯ç¤ºé¡Œè™Ÿ #}
            <p id="question"></p> {# é¡¯ç¤ºé¡Œç›®æ–‡å­—æç¤º #}
            <ul id="options" class="quiz-options"></ul> {# é¡¯ç¤ºé¸é … #}
        </div>
        
        {# å°èˆªæŒ‰éˆ•å€åŸŸ #}
        <div class="navigation-buttons">
            <button id="prev-btn" class="nav-btn">
                <i class="fas fa-arrow-left"></i> ä¸Šä¸€é¡Œ
            </button>
            <button id="next-btn" class="nav-btn">
                ä¸‹ä¸€é¡Œ <i class="fas fa-arrow-right"></i>
            </button>
            <button id="submit-btn" class="submit-btn" style="display: none;">
                å®Œæˆæ¸¬é©— <i class="fas fa-check"></i>
            </button>
        </div>

        <div class="result-display" style="display: none;">
            <h2>æ‚¨çš„æ¸¬é©—çµæœ</h2>
            <div class="score-summary">
                <p>ç­”å°é¡Œç›®: <span id="correct-count">0</span> / <span id="total-questions">0</span></p>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="score-progress-bar"></div>
            </div>
            <div class="score-text">
                <span id="score-percentage">0%</span>
            </div>
        </div>
    </div>

    <a href="{% url 'test' %}" id="backButton">å›åˆ°ä¸Šä¸€é </a>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // æ‡‰ç­”å•é¡Œç‰¹æœ‰çš„éŸ³æª”å’Œé¡Œç›®æ•¸æ“š (å·²ç¸®æ¸›è‡³4é¡Œ)
    const listeningDataPart2 = [
        {
            id: "q1",
            audio: "What did you think of the presentation?",
            question: "Q1:", // ä¿æŒ QX: çš„æ ¼å¼
            options: [
                "A) I thought it was very informative.",
                "B) He presented it last week.",
                "C) Yes, I will attend.",
                "D) The presentation will be postponed."
            ],
            correct: 0,
            userAnswer: null
        },
        {
            id: "q2",
            audio: "Excuse me, could you tell me where the nearest post office is?",
            question: "Q2:",
            options: [
                "A) No, I haven't mailed it yet.",
                "B) It's around the corner, next to the bank.",
                "C) I'm sorry, I don't post letters.",
                "D) The office is closed now."
            ],
            correct: 1,
            userAnswer: null
        },
        {
            id: "q3",
            audio: "Have you finished your report yet?",
            question: "Q3:",
            options: [
                "A) Yes, it's already on your desk.",
                "B) I'll report it soon.",
                "C) No, I don't think so.",
                "D) The report is due tomorrow."
            ],
            correct: 0,
            userAnswer: null
        },
        {
            id: "q4",
            audio: "Could you please pass me the salt?",
            question: "Q4:",
            options: [
                "A) No, thank you.",
                "B) Here you go.",
                "C) It's too salty.",
                "D) I don't have any salt."
            ],
            correct: 1,
            userAnswer: null
        }
    ];

    let currentQuizIndex = 0; // ç•¶å‰é¡¯ç¤ºçš„é¡Œç›®ç´¢å¼•
    let isReviewMode = false; // æ–°å¢ä¸€å€‹ç‹€æ…‹è®Šæ•¸ä¾†è¿½è¹¤æ˜¯å¦åœ¨æŸ¥çœ‹è©³è§£æ¨¡å¼

    // ğŸ·ï¸ã€æ–‡æœ¬æœ—è®€åŠŸèƒ½ã€‘ - ç¢ºä¿åªæœ‰é€™ä¸€å€‹å®šç¾©
    let speech = new SpeechSynthesisUtterance();

    // ç²å– DOM å…ƒç´ 
    const questionNumberElement = document.getElementById("question-number"); // é€™å€‹å…ƒç´ å°‡é¡¯ç¤º "é¡Œç›® X / Y"
    const questionElement = document.getElementById("question");           // é€™å€‹å…ƒç´ å°‡é¡¯ç¤º "QZ:"
    const optionsElement = document.getElementById("options"); // è«‹ç¢ºä¿ ul.quiz-options æœ‰ id="options"

    // ç²å–éŸ³é »æ’­æ”¾å™¨åŠå…¶æŒ‰éˆ•
    const audioPlayerBox = document.querySelector('.audio-player-box');
    const playAudioBtn = document.getElementById("play-audio-btn");
    const stopAudioBtn = document.getElementById("stop-audio-btn");

    // ç²å–å°èˆªæŒ‰éˆ•
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const submitBtn = document.getElementById("submit-btn");

    // ç²å–çµæœé¡¯ç¤ºç›¸é—œå…ƒç´ 
    const resultDisplay = document.querySelector('.result-display');
    const correctCountSpan = document.getElementById('correct-count');
    const totalQuestionsSpan = document.getElementById('total-questions');
    const scoreProgressBar = document.getElementById('score-progress-bar');
    const scorePercentageSpan = document.getElementById('score-percentage');

    // **æ–°å¢ï¼šç²å–æˆ–å‰µå»ºã€Œè¿”å›ã€æŒ‰éˆ•çš„åƒè€ƒ**
    let endReviewBtn = document.getElementById('end-review-btn');
    if (!endReviewBtn) {
        endReviewBtn = document.createElement('button');
        endReviewBtn.innerText = 'è¿”å›'; // **å°‡æ–‡å­—ä¿®æ”¹ç‚ºã€Œè¿”å›ã€**
        endReviewBtn.id = 'end-review-btn';
        endReviewBtn.classList.add('nav-btn', 'mt-4');
        // å°‡å®ƒæ·»åŠ åˆ°å°èˆªæŒ‰éˆ•çš„å®¹å™¨ï¼Œç¢ºä¿å®ƒå­˜åœ¨æ–¼ DOM ä¸­ä»¥ä¾¿æ§åˆ¶
        // å‡è¨­ .navigation-buttons æ˜¯ä½ çš„å°èˆªæŒ‰éˆ•å®¹å™¨
        const navButtonsContainer = document.querySelector('.navigation-buttons');
        if (navButtonsContainer) {
            navButtonsContainer.appendChild(endReviewBtn);
        } else {
            document.body.appendChild(endReviewBtn); // ä½œç‚ºå‚™ç”¨ï¼Œå¦‚æœæ‰¾ä¸åˆ°å®¹å™¨å°±åŠ åˆ° body
        }
        endReviewBtn.style.display = 'none'; // é è¨­éš±è—
    }

    // æ’­æ”¾ç•¶å‰é¡Œç›®çš„éŸ³é »
    function playQuestionAudio() {
        if (currentQuizIndex < listeningDataPart2.length) {
            stopSpeech(); // åœæ­¢ä»»ä½•æ­£åœ¨æ’­æ”¾çš„èªéŸ³
            speech.text = listeningDataPart2[currentQuizIndex].audio; // ä½¿ç”¨é¡Œç›®éŸ³é »
            speech.lang = "en-US"; // è¨­ç½®èªè¨€ç‚ºè‹±æ–‡
            speech.rate = 0.9; // è¨­ç½®èªé€Ÿ
            speech.pitch = 1; // è¨­ç½®éŸ³é«˜

            // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´èªéŸ³åˆæˆ
            if (window.speechSynthesis) {
                window.speechSynthesis.speak(speech);
                console.log("Playing: " + listeningDataPart2[currentQuizIndex].audio);
            } else {
                console.warn("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒèªéŸ³åˆæˆã€‚");
            }
        }
    }

    // ğŸ·ï¸ã€åœæ­¢æœ—è®€åŠŸèƒ½ã€‘- çµ±ä¸€ç‚ºé€™ä¸€å€‹
    function stopSpeech() {
        if (window.speechSynthesis && window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel(); // åœæ­¢æ‰€æœ‰èªéŸ³åˆæˆ
        }
    }

    // è¼‰å…¥ä¸¦é¡¯ç¤ºæŒ‡å®šç´¢å¼•çš„é¡Œç›®
    function loadQuestion(index) {
        stopSpeech(); // åˆ‡æ›é¡Œç›®æ™‚åœæ­¢ç•¶å‰éŸ³é »
        currentQuizIndex = index; // æ›´æ–°ç•¶å‰é¡Œç›®ç´¢å¼•

        // ç¸½æ˜¯éš±è—çµæœé¡¯ç¤ºå€åŸŸ
        if (resultDisplay) {
            resultDisplay.style.display = 'none';
        }

        // é¡¯ç¤ºé¡Œç›®ç›¸é—œå…ƒç´ 
        if (questionNumberElement) questionNumberElement.style.display = 'block';
        if (questionElement) questionElement.style.display = 'block';
        if (optionsElement) optionsElement.style.display = 'block';

        if (audioPlayerBox) {
            audioPlayerBox.style.display = 'block';
            if (playAudioBtn) playAudioBtn.style.pointerEvents = 'auto';
            if (stopAudioBtn) stopAudioBtn.style.pointerEvents = 'auto';
        }

        if (currentQuizIndex < listeningDataPart2.length && currentQuizIndex >= 0) {
            const quizData = listeningDataPart2[currentQuizIndex];

            // å°‡é¡Œç›®é€²åº¦é¡¯ç¤ºåœ¨ questionNumberElement
            if (questionNumberElement) {
                questionNumberElement.innerText = `é¡Œç›® ${currentQuizIndex + 1} / ${listeningDataPart2.length}`;
            }

            // å°‡å¯¦éš›å•é¡Œæ–‡å­—é¡¯ç¤ºåœ¨ questionElement
            if (questionElement) {
                questionElement.innerText = quizData.question;
            }

            optionsElement.innerHTML = ""; // æ¸…ç©ºèˆŠé¸é …

            quizData.options.forEach((option, optionIndex) => {
                const li = document.createElement("li");
                li.innerText = option;
                li.classList.add("option-item");
                li.dataset.optionIndex = optionIndex; // ç”¨æ–¼å¿«é€ŸæŸ¥æ‰¾é¸é …

                if (isReviewMode) { // åœ¨æŸ¥çœ‹è©³è§£æ¨¡å¼ä¸‹
                    li.style.pointerEvents = 'none'; // ç¦ç”¨æ‰€æœ‰é¸é …çš„é»æ“Š

                    if (optionIndex === quizData.userAnswer) {
                        li.classList.add("selected"); // ç”¨æˆ¶é¸æ“‡çš„ç­”æ¡ˆ
                    }
                    if (optionIndex === quizData.correct) {
                        li.classList.add("correct"); // æ­£ç¢ºç­”æ¡ˆ
                    } else if (optionIndex === quizData.userAnswer && optionIndex !== quizData.correct) {
                        li.classList.add("incorrect"); // ç”¨æˆ¶ç­”æ¡ˆéŒ¯èª¤
                    }
                } else { // åœ¨ä½œç­”æ¨¡å¼ä¸‹
                    if (quizData.userAnswer !== null && optionIndex === quizData.userAnswer) {
                        li.classList.add("selected");
                    }
                    // åªæœ‰åœ¨ä½œç­”æ¨¡å¼ä¸‹æ‰æ·»åŠ é»æ“Šäº‹ä»¶
                    li.addEventListener("click", function () {
                        // ç§»é™¤æ‰€æœ‰é¸é …çš„ 'selected' class
                        optionsElement.querySelectorAll('.option-item').forEach(item => {
                            item.classList.remove('selected');
                        });

                        // ç‚ºç•¶å‰é¸æ“‡çš„é¸é …æ·»åŠ  'selected' class
                        li.classList.add("selected");
                        quizData.userAnswer = optionIndex; // å„²å­˜ç”¨æˆ¶ç­”æ¡ˆ
                    });
                }
                optionsElement.appendChild(li);
            });
        } else {
            // é€™å€‹åˆ†æ”¯é€šå¸¸ä¸æ‡‰åœ¨æ­£å¸¸æ¸¬é©—æµç¨‹ä¸­è¢«è¨ªå•
            if (questionNumberElement) questionNumberElement.innerText = "";
            if (questionElement) questionElement.innerText = "æ²’æœ‰é¡Œç›®å¯é¡¯ç¤ºæˆ–ç™¼ç”ŸéŒ¯èª¤ã€‚";
            if (optionsElement) optionsElement.innerHTML = "";
            if (audioPlayerBox) {
                audioPlayerBox.style.display = 'none';
            }
        }
        updateNavigationButtons(); // è¼‰å…¥é¡Œç›®å¾Œæ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    }

    // æ›´æ–°å°èˆªæŒ‰éˆ•çš„å•Ÿç”¨/ç¦ç”¨ç‹€æ…‹å’Œé¡¯ç¤º/éš±è—
    function updateNavigationButtons() {
        let reviewAnswersBtn = document.getElementById('review-answers-btn'); 

        if (prevBtn) {
            prevBtn.disabled = currentQuizIndex === 0;
            prevBtn.style.visibility = (currentQuizIndex === 0) ? 'hidden' : 'visible';
            prevBtn.style.display = 'block'; // ç¢ºä¿æŒ‰éˆ•å¯è¦‹
        }

        if (nextBtn) {
            nextBtn.style.display = 'block'; // ç¢ºä¿æŒ‰éˆ•å¯è¦‹
        }
        if (submitBtn) {
            submitBtn.style.display = 'none'; // é è¨­éš±è—æäº¤æŒ‰éˆ•
        }

        // ç¢ºä¿åœ¨ä»»ä½•æ™‚å€™ï¼Œå¦‚æœä¸åœ¨æŸ¥çœ‹æ­£è§£æ¨¡å¼ï¼Œé€™äº›æŒ‰éˆ•éƒ½éš±è—
        if (reviewAnswersBtn) reviewAnswersBtn.style.display = 'none'; 
        if (endReviewBtn) endReviewBtn.style.display = 'none'; // **é è¨­éš±è—ã€Œè¿”å›ã€æŒ‰éˆ•**

        if (isReviewMode) { // åœ¨æŸ¥çœ‹è©³è§£æ¨¡å¼ä¸‹
            if (currentQuizIndex === listeningDataPart2.length - 1) {
                // å¦‚æœæ˜¯æœ€å¾Œä¸€é¡Œï¼Œéš±è—ä¸‹ä¸€é¡ŒæŒ‰éˆ•
                if (nextBtn) nextBtn.style.display = 'none';
            }
            // æäº¤æŒ‰éˆ•åœ¨æŸ¥çœ‹è©³è§£æ¨¡å¼ä¸‹å§‹çµ‚éš±è—
            if (submitBtn) submitBtn.style.display = 'none';
            // **åªæœ‰åœ¨æŸ¥çœ‹æ­£è§£æ¨¡å¼ä¸‹æ‰é¡¯ç¤ºã€Œè¿”å›ã€æŒ‰éˆ•**
            if (endReviewBtn) endReviewBtn.style.display = 'block'; 

        } else { // åœ¨ä½œç­”æ¨¡å¼ä¸‹
            if (currentQuizIndex === listeningDataPart2.length - 1) {
                // æœ€å¾Œä¸€é¡Œï¼šéš±è—ä¸‹ä¸€é¡Œï¼Œé¡¯ç¤ºå®Œæˆä½œç­”
                if (nextBtn) nextBtn.style.display = 'none';
                if (submitBtn) submitBtn.style.display = 'block';
            } else {
                // éæœ€å¾Œä¸€é¡Œï¼šé¡¯ç¤ºä¸‹ä¸€é¡Œï¼Œéš±è—å®Œæˆä½œç­”
                if (nextBtn) nextBtn.style.display = 'block';
                if (submitBtn) submitBtn.style.display = 'none';
            }
        }
    }

    // é¡¯ç¤ºä¸‹ä¸€é¡Œ
    function showNextQuestion() {
        if (currentQuizIndex < listeningDataPart2.length - 1) {
            loadQuestion(currentQuizIndex + 1);
        } else if (isReviewMode && currentQuizIndex === listeningDataPart2.length - 1) {
            // åœ¨æŸ¥çœ‹è©³è§£æ¨¡å¼çš„æœ€å¾Œä¸€é¡Œé»æ“Šã€Œä¸‹ä¸€é¡Œã€æ™‚ï¼Œå›åˆ°çµæœé é¢
            submitResults(); 
        } else {
             console.log("å·²ç¶“æ˜¯æœ€å¾Œä¸€é¡Œã€‚");
        }
    }

    // é¡¯ç¤ºä¸Šä¸€é¡Œ
    function showPreviousQuestion() {
        if (currentQuizIndex > 0) {
            loadQuestion(currentQuizIndex - 1);
        }
    }

    // è¨ˆç®—ç¸½åˆ†
    function calculateScore() {
        let score = 0;
        listeningDataPart2.forEach(q => {
            if (q.userAnswer !== null && q.userAnswer === q.correct) {
                score++;
            }
        });
        return score;
    }

    // è™•ç†å®Œæˆä½œç­”ä¸¦é¡¯ç¤ºå¾—åˆ† (ä½¿ç”¨é€²åº¦æ¢æ–¹å¼)
    function submitResults() {
        stopSpeech(); // åœæ­¢æ‰€æœ‰èªéŸ³æ’­æ”¾

        // åªæœ‰åœ¨éæŸ¥çœ‹è©³è§£æ¨¡å¼ä¸‹æ‰æª¢æŸ¥æ˜¯å¦å…¨éƒ¨ä½œç­”
        if (!isReviewMode) { 
            const allAnswered = listeningDataPart2.every(q => q.userAnswer !== null);
            if (!allAnswered) {
                alert('è«‹å›ç­”æ‰€æœ‰å•é¡Œå¾Œå†æäº¤ï¼');
                return;
            }
        }

        const finalScore = calculateScore();
        const totalQuestions = listeningDataPart2.length;
        const percentage = (totalQuestions > 0) ? (finalScore / totalQuestions) * 100 : 0;

        // éš±è—æ¸¬é©—å€åŸŸçš„æ‰€æœ‰å…ƒç´ 
        if (questionNumberElement) questionNumberElement.style.display = 'none';
        if (questionElement) questionElement.style.display = 'none';
        if (optionsElement) optionsElement.style.display = 'none';
        if (audioPlayerBox) {
            audioPlayerBox.style.display = 'none';
        }

        // éš±è—æ‰€æœ‰å°èˆªæŒ‰éˆ•
        if (prevBtn) prevBtn.style.display = 'none';
        if (nextBtn) nextBtn.style.display = 'none';
        if (submitBtn) submitBtn.style.display = 'none';
        if (endReviewBtn) endReviewBtn.style.display = 'none'; // **åœ¨é¡¯ç¤ºæˆç¸¾æ™‚ï¼Œç¢ºä¿ã€Œè¿”å›ã€æŒ‰éˆ•éš±è—**

        // é¡¯ç¤ºçµæœå€åŸŸ
        if (resultDisplay) {
            resultDisplay.style.display = 'block';
            correctCountSpan.innerText = finalScore;
            totalQuestionsSpan.innerText = totalQuestions;
            scoreProgressBar.style.width = `${percentage}%`;
            scorePercentageSpan.innerText = `${percentage.toFixed(0)}%`; // é¡¯ç¤ºç™¾åˆ†æ¯”ï¼Œä¿ç•™æ•´æ•¸

            // æ ¹æ“šåˆ†æ•¸èª¿æ•´ç™¾åˆ†æ¯”æ–‡å­—é¡è‰²å’Œé€²åº¦æ¢é¡è‰²
            if (percentage >= 80) {
                scorePercentageSpan.className = 'score-text excellent';
                scoreProgressBar.style.background = 'linear-gradient(90deg, #28a745, #5cb85c)'; // ç¶ è‰²
            } else if (percentage >= 60) {
                scorePercentageSpan.className = 'score-text good';
                scoreProgressBar.style.background = 'linear-gradient(90deg, #ffc107, #ffdb58)'; // é»ƒè‰²
            } else {
                scorePercentageSpan.className = 'score-text poor';
                scoreProgressBar.style.background = 'linear-gradient(90deg, #dc3545, #fd7e14)'; // ç´…è‰²åˆ°æ©™è‰²
            }

            // å‰µå»ºä¸¦æ·»åŠ ã€ŒæŸ¥çœ‹æ­£è§£ã€æŒ‰éˆ•
            let reviewAnswersBtn = document.getElementById('review-answers-btn');
            if (!reviewAnswersBtn) { // é¿å…é‡è¤‡å‰µå»º
                reviewAnswersBtn = document.createElement('button');
                reviewAnswersBtn.innerText = 'æŸ¥çœ‹æ­£è§£'; 
                reviewAnswersBtn.id = 'review-answers-btn';
                reviewAnswersBtn.classList.add('nav-btn', 'mt-4'); 
                resultDisplay.appendChild(reviewAnswersBtn);
            }
            reviewAnswersBtn.style.display = 'block'; // ç¢ºä¿æŒ‰éˆ•å¯è¦‹

            // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½ï¼Œå†é‡æ–°ç¶å®š (é˜²æ­¢é‡è¤‡è§¸ç™¼)
            reviewAnswersBtn.replaceWith(reviewAnswersBtn.cloneNode(true));
            reviewAnswersBtn = document.getElementById('review-answers-btn');

            reviewAnswersBtn.onclick = function() {
                isReviewMode = true; // è¨­å®šç‚ºæŸ¥çœ‹è©³è§£æ¨¡å¼
                loadQuestion(0); // é‡æ–°è¼‰å…¥ç¬¬ä¸€é¡Œï¼Œç¾åœ¨æœƒé¡¯ç¤ºç­”æ¡ˆå°éŒ¯

                // éš±è—å¾—åˆ†çµæœå€åŸŸ
                if (resultDisplay) resultDisplay.style.display = 'none';

                // é¡¯ç¤ºå‰å¾ŒæŒ‰éˆ•ï¼Œéš±è—æäº¤æŒ‰éˆ•å’ŒæŸ¥çœ‹æ­£è§£æŒ‰éˆ•
                if (prevBtn) prevBtn.style.display = 'block';
                if (nextBtn) nextBtn.style.display = 'block';
                if (submitBtn) submitBtn.style.display = 'none';
                reviewAnswersBtn.style.display = 'none'; // éš±è—è‡ªèº«

                // ã€Œè¿”å›ã€æŒ‰éˆ•æœƒåœ¨é€™è£¡æ ¹æ“š isReviewMode ç‹€æ…‹é¡¯ç¤º
                updateNavigationButtons(); // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            };
        }
    }

    // äº‹ä»¶ç›£è½å™¨ç¶å®š
    if (playAudioBtn) {
        playAudioBtn.addEventListener('click', playQuestionAudio);
    }
    if (stopAudioBtn) {
        stopAudioBtn.addEventListener('click', stopSpeech);
    }
    if (prevBtn) {
        prevBtn.addEventListener('click', showPreviousQuestion);
    }
    if (nextBtn) {
        nextBtn.addEventListener('click', showNextQuestion);
    }
    if (submitBtn) {
        submitBtn.addEventListener('click', submitResults);
    }
    // ç‚ºã€Œè¿”å›ã€æŒ‰éˆ•ç¶å®šäº‹ä»¶
    if (endReviewBtn) {
        endReviewBtn.addEventListener('click', function() {
            isReviewMode = false; // çµæŸæŸ¥çœ‹è©³è§£æ¨¡å¼
            submitResults(); // é‡æ–°å›åˆ°çµæœé é¢
        });
    }

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    window.addEventListener("load", function() {
        if (listeningDataPart2.length > 0) {
            loadQuestion(0); // è¼‰å…¥ç¬¬ä¸€é“é¡Œç›®
        } else {
            // é¡¯ç¤º"æ²’æœ‰é¡Œç›®"è¨Šæ¯æ™‚ï¼Œæ›´æ–° questionElement
            if (questionNumberElement) questionNumberElement.innerText = "";
            if (questionElement) questionElement.innerText = "æ²’æœ‰é¡Œç›®å¯é¡¯ç¤ºã€‚"; // é¡¯ç¤ºè¨Šæ¯
            if (optionsElement) optionsElement.innerHTML = ""; // æ¸…ç©ºé¸é …
            if (audioPlayerBox) {
                audioPlayerBox.style.display = 'none'; // å¦‚æœæ²’æœ‰é¡Œç›®ï¼Œéš±è—éŸ³é »æ’­æ”¾å™¨
            }
            // éš±è—æ‰€æœ‰å°èˆªæŒ‰éˆ•å’Œçµæœé¡¯ç¤ºå€
            if (prevBtn) prevBtn.style.display = 'none';
            if (nextBtn) nextBtn.style.display = 'none';
            if (submitBtn) submitBtn.style.display = 'none';
            if (resultDisplay) resultDisplay.style.display = 'none';
            // åŒæ™‚éš±è—ã€Œè¿”å›ã€æŒ‰éˆ•
            if (endReviewBtn) endReviewBtn.style.display = 'none';
        }
    });

    // é é¢å¯è¦‹æ€§è®ŠåŒ–æ™‚åœæ­¢æœ—è®€
    document.addEventListener("visibilitychange", function() {
        if (document.hidden) {
            stopSpeech();
        }
    });
});
</script>
</body>
</html>