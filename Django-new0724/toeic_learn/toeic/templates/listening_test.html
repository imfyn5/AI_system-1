{% load static %}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEICå­¸ç¿’å¹³å° - è½åŠ›æ¸¬é©—</title>
    <link rel="stylesheet" href="{% static 'css/common.css' %}">
    <link rel="stylesheet" href="{% static 'css/listening_test.css' %}">
    <script src="{% static 'script/all.js' %}"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="header">
        <button class="menu-btn" id="menu-btn">â˜°</button>
        <h1>TOEICå­¸ç¿’å¹³å°</h1>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span class="listening-title">è½åŠ›æ¸¬é©—</span>
    </div>
    <div class="container">
        <h1>Listening Comprehension</h1>
        <p>ç™¼ä½ˆæ—¥æœŸ: <span id="currentDate"></span></p>
        <div class="category-box">é¡åˆ¥: <span id="category"></span></div>
        <div class="passage-box">
            <p id="audio-instruction">è«‹è†è½ä»¥ä¸‹å…§å®¹ä¸¦å›ç­”å•é¡Œï¼š</p>
            <button class="start-speech" onclick="speakText()">Start</button>
            <button class="stop-speech" onclick="stopSpeech()">Stop</button>            
        </div>

        <div class="quiz-box">
            <p id="question"></p>
            <ul id="options" class="quiz-options"></ul>
        </div>
    </div>
    </div>
    <a href="{% url 'test' %}" id="backButton">å›åˆ°ä¸Šä¸€é </a>
    
    <script>
        // ğŸ·ï¸ã€æ–‡æœ¬æœ—è®€åŠŸèƒ½ã€‘
        let speech;
        
        function speakText() {  
            const text = `Please listen to the following content:
            The Eiffel Tower, located in Paris, France, was built in 1889.
            Originally constructed as the entrance arch for the 1889 World's Fair, the event celebrated the 100th anniversary of the French Revolution.
            Designed by engineer Gustave Eiffel, the tower stands 300 meters (984 feet) tall, making it one of the tallest structures in the world at the time.
            Made of iron, the tower initially faced criticism but later became a global cultural symbol of France.`;

            speech = new SpeechSynthesisUtterance(text);
            speech.lang = "en-US";  // è¨­ç½®èªè¨€ç‚ºè‹±æ–‡
            speech.rate = 1;  // è¨­ç½®èªé€Ÿ
            speech.pitch = 1;  // è¨­ç½®éŸ³é«˜
            window.speechSynthesis.speak(speech);
        }

        // ğŸ·ï¸ã€åœæ­¢æœ—è®€åŠŸèƒ½ã€‘
        function stopSpeech() {
            window.speechSynthesis.cancel(); // åœæ­¢æ‰€æœ‰èªéŸ³åˆæˆ
        }
        // å‡è®¾å·²ç»å®šä¹‰äº† speakText å’Œ stopSpeech å‡½æ•°

        // æš‚åœæœ—è¯»çš„å‡½æ•°
        function stopSpeech() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel(); // å–æ¶ˆå½“å‰æ­£åœ¨æœ—è¯»çš„å†…å®¹
            }
        }

        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œç›‘å¬é¡µé¢çš„å¯è§æ€§å˜åŒ–
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                stopSpeech(); // å¦‚æœé¡µé¢ä¸å¯è§ï¼Œæš‚åœæœ—è¯»
            }
        });

        // ğŸ·ï¸ã€é¡¯ç¤ºç•¶å‰æ—¥æœŸã€‘
        document.getElementById("currentDate").textContent = new Date().toISOString().split('T')[0];

        // ğŸ·ï¸ã€åˆ†é¡æ¨™ç±¤å°æ‡‰çš„é—œéµå­—ã€‘
        const categoryKeywords = {
            "æ­·å²": ["eiffel tower", "constructed", "1889", "landmarks"],
            "æ—…éŠ": ["paris", "visitors", "famous", "attracts"],
            "å»ºç¯‰": ["constructed", "landmarks", "tower"],
            "æ–‡åŒ–": ["world", "famous", "heritage"],
            "ç§‘æŠ€": ["innovation", "engineering", "design"]
        };

        // ğŸ·ï¸ã€éŸ³æª”è†è½å…§å®¹ã€‘
        const extendedAudioText = `Please listen to the following content:
        The Eiffel Tower, located in Paris, France, was built in 1889.
        Originally constructed as the entrance arch for the 1889 World's Fair, the event celebrated the 100th anniversary of the French Revolution.
        Designed by engineer Gustave Eiffel, the tower stands 300 meters (984 feet) tall, making it one of the tallest structures in the world at the time.
        Made of iron, the tower initially faced criticism but later became a global cultural symbol of France.
        `;

        // ğŸ·ï¸ã€å­˜å–æœ¬åœ°å„²å­˜ã€‘
        localStorage.setItem("audioText", extendedAudioText);
        const audioText = localStorage.getItem("audioText") || "";

        // ğŸ·ï¸ã€åˆ†é¡æ¨™ç±¤åˆ¤æ–·ã€‘
        let selectedCategories = [];
        for (const [category, keywords] of Object.entries(categoryKeywords)) {
            if (keywords.some(keyword => audioText.includes(keyword))) {
                selectedCategories.push(category);
            }
        }

        // è‹¥ç„¡é—œè¯é¡åˆ¥ï¼Œéš¨æ©Ÿé¸æ“‡ä¸€å€‹
        if (selectedCategories.length === 0) {
            const randomCategories = Object.keys(categoryKeywords);
            selectedCategories.push(randomCategories[Math.floor(Math.random() * randomCategories.length)]);
        }

        // é¡¯ç¤ºåˆ†é¡æ¨™ç±¤
        document.getElementById("category").innerHTML = selectedCategories
            .map(cat => `<span>#${cat}</span>`)
            .join(" ");

        // ğŸ·ï¸ã€æ¸¬é©—é¡Œç›®èˆ‡é¸é …ã€‘
        const listeningData = [
            { question: "1. When was the Eiffel Tower built?", options: ["1889", "1905", "1856", "1923"], correct: 0 },
            { question: "2. Who designed the Eiffel Tower?", options: ["Gustave Eiffel", "Alexander Gustave", "Pierre Eiffel", "Charles Eiffel"], correct: 0 },
            { question: "3. What was the Eiffel Tower originally built for?", options: ["World's Fair", "Tourism", "Military base", "Radio transmission"], correct: 0 },
            { question: "4. How tall is the Eiffel Tower?", options: ["300 meters", "200 meters", "150 meters", "400 meters"], correct: 0 },
            { question: "5. What material is the Eiffel Tower primarily made of?", options: ["Steel", "Concrete", "Wood", "Brick"], correct: 0 }
        ];

        // ğŸ·ï¸ã€æ¸¬é©—åŠŸèƒ½ã€‘
        let currentQuestionIndex = 0;
        let score = 0;

        // ğŸ·ï¸ã€è¼‰å…¥é¡Œç›®ã€‘
        function loadQuestion() {
            if (currentQuestionIndex < listeningData.length) {
                const questionData = listeningData[currentQuestionIndex];
                document.getElementById("question").innerText = questionData.question;
                const optionsElement = document.getElementById("options");
                optionsElement.innerHTML = "";

                questionData.options.forEach((option, index) => {
                    const li = document.createElement("li");
                    li.innerText = option;

                    // é»æ“Šé¸é …æ™‚æª¢æŸ¥ç­”æ¡ˆ
                    li.addEventListener("click", function () {
                        if (index === questionData.correct) {
                            li.classList.add("correct");
                            score++; // å¢åŠ åˆ†æ•¸
                        } else {
                            li.classList.add("incorrect");
                        }
                        
                        // ç¦ç”¨æ‰€æœ‰é¸é …
                        optionsElement.querySelectorAll('li').forEach(item => item.style.pointerEvents = 'none');

                        currentQuestionIndex++;
                        setTimeout(loadQuestion, 1000); // 1ç§’å¾Œè¼‰å…¥ä¸‹ä¸€é¡Œ
                    });

                    optionsElement.appendChild(li);
                });
            } else {
                // æ¸¬é©—çµæŸæ™‚é¡¯ç¤ºåˆ†æ•¸
                document.getElementById("question").innerText = `æ¸¬é©—çµæŸï¼æ‚¨çš„å¾—åˆ†æ˜¯ ${score} / ${listeningData.length}`;
                document.getElementById("options").innerHTML = "";
            }
        }

        // ğŸ·ï¸ã€åˆå§‹åŒ–æ¸¬é©—ã€‘
        window.addEventListener("load", function() {
            loadQuestion();
        });
    </script>
</body>
<footer class="footer">
    <div class="footer-container">
        <!-- è¯çµ¡æˆ‘å€‘å€å¡Š -->
        <div class="contact-us">
            <h3>è¯çµ¡æˆ‘å€‘</h3>
            <ul>
                <li><i class="fas fa-phone"></i><a href="tel:02 3322 2777"> é›»è©±ï¼š02 3322 2777</a></li>
                <li><i class="fas fa-map"></i><a href="https://maps.app.goo.gl/3NMVwufcbbTrfQNz6" target="_blank"> åœ°å€ï¼š100å°åŒ—å¸‚ä¸­æ­£å€æ¿Ÿå—è·¯ä¸€æ®µ321è™Ÿ</a></li>
                <iframe src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d14459.01851827243!2d121.5254698!3d25.0423998!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3442a970a11a84ad%3A0x58e05f2528812097!2z5ZyL56uL6Ie65YyX5ZWG5qWt5aSn5a24!5e0!3m2!1szh-TW!2stw!4v1728891709611!5m2!1szh-TW!2stw" 
                width="300"
                height="250"
                style="border:0;"
                allowfullscreen=""
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade">
                </iframe>
            </ul>
        </div>
    </div>
    <div class="footer-bottom">
        <p>&copy; 2024 TOEICå­¸ç¿’å¹³å° ç‰ˆæ¬Šæ‰€æœ‰</p>
    </div>
</footer>
</html>
